

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Firmware Updates &amp; Programming &mdash; trigBoard
Version 8 0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Testing/Factory Programming" href="testing.html" />
    <link rel="prev" title="Hardware" href="Hardware.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html">
          

          
            
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">trigBoard v8 Docs</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="wheretobuy.html">Where To Buy</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="configurator.html">Configurator</a></li>
<li class="toctree-l1"><a class="reference internal" href="supportedServices.html">Supported Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="Hardware.html">Hardware</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Firmware Updates &amp; Programming</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#check-version">Check Version</a></li>
<li class="toctree-l2"><a class="reference internal" href="#wireless-updates-ota">Wireless Updates (OTA)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#alternate-ota-method">Alternate OTA Method</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#usb-updates">USB Updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#compiling-uploading-base-firmware">Compiling/Uploading Base Firmware</a></li>
<li class="toctree-l2"><a class="reference internal" href="#custom-firmware">Custom Firmware</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing/Factory Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="contact.html">Contact</a></li>
</ul>
<p class="caption"><span class="caption-text">Projects</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="ePaperCoronaDisplay.html">E-Paper Corona Display</a></li>
<li class="toctree-l1"><a class="reference internal" href="cellularProject.html">Cellular/Battery Backed System UDP/TCP</a></li>
<li class="toctree-l1"><a class="reference internal" href="doorbell.html">Door Bell Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="garage.html">Garage Door Monitor</a></li>
<li class="toctree-l1"><a class="reference internal" href="homeassistant.html">Home Assistant</a></li>
<li class="toctree-l1"><a class="reference internal" href="LogGoogleDocs.html">Log to Google Sheet - IFTTT</a></li>
<li class="toctree-l1"><a class="reference internal" href="motionSensor.html">Motion Sensor - PIR</a></li>
<li class="toctree-l1"><a class="reference internal" href="multipleInputs.html">Multiple Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="SendEmail.html">Send an Email - IFTTT</a></li>
<li class="toctree-l1"><a class="reference internal" href="SmokeCODetector.html">Smoke/CO Detector</a></li>
<li class="toctree-l1"><a class="reference internal" href="solar.html">Solar Powered</a></li>
<li class="toctree-l1"><a class="reference internal" href="temperatureSensor.html">Temperature Logging Corlysis + Home Asst</a></li>
<li class="toctree-l1"><a class="reference internal" href="waterleakDetector.html">Water Leak Detector</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">trigBoard
Version 8</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Firmware Updates &amp; Programming</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/Firmware.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="firmware-updates-programming">
<span id="firmware"></span><h1>Firmware Updates &amp; Programming<a class="headerlink" href="#firmware-updates-programming" title="Permalink to this headline">¶</a></h1>
<div class="section" id="check-version">
<h2>Check Version<a class="headerlink" href="#check-version" title="Permalink to this headline">¶</a></h2>
<p>Every trigBoard shipped is pre-programmed with a release of the base firmware, but this is under heavy development, so it is a good idea to first check to make sure you have the latest version loaded.  Here’s how to check that:</p>
<ul>
<li><p class="first">Launch the <a class="reference internal" href="configurator.html#configurator"><span class="std std-ref">Configurator Tool</span></a>, hold the wake button on the trigBoard until the LED is flashing, then connect to the board from the Configurator.  At the top of the page, you’ll see the date code of the firmware:</p>
<blockquote>
<div><img alt="_images/configfwversionof.png" class="align-center" src="_images/configfwversionof.png" />
</div></blockquote>
</li>
<li><p class="first">Head over to the <a class="reference external" href="https://github.com/krdarrah/trigBoardV8_BaseFirmware/releases">releases git page</a> and see if there is a newer date code:</p>
<blockquote>
<div><img alt="_images/gitreleaselatestdatecode.png" class="align-center" src="_images/gitreleaselatestdatecode.png" />
</div></blockquote>
</li>
</ul>
<p>If a newer version exists, don’t worry because it’s very easy to upload - even wirelessy using OTA (OVER THE AIR) updates</p>
</div>
<div class="section" id="wireless-updates-ota">
<h2>Wireless Updates (OTA)<a class="headerlink" href="#wireless-updates-ota" title="Permalink to this headline">¶</a></h2>
<p>Here is a quick video showing the complete process to update the Firmware using OTA:</p>
<blockquote>
<div><div style="text-align: center; margin-bottom: 2em;">
        <iframe width="560" height="315" src="https://www.youtube.com/embed/QmJfK1wJ-ow" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div></div></blockquote>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<div class="last line-block">
<div class="line">Something went wrong? Here are some troubleshooting tips:</div>
<div class="line">- Make sure the trigBoard is connected to the same network as the computer running the trigUpdater app</div>
<div class="line">- If your FW is older, OTA was really not reliable, so just keep trying… it should eventually complete.  If not, you can check out uploading over USB.</div>
<div class="line">- Make sure the battery is fresh/fully charged</div>
</div>
</div>
<p>The latest bin file can always be downloaded from the <a class="reference external" href="https://github.com/krdarrah/trigBoardV8_BaseFirmware/releases">releases git page</a></p>
<p>The trigUpdater app for your OS can be downloaded <a class="reference external" href="https://github.com/krdarrah/trigUpdater/releases">from here</a></p>
<div class="section" id="alternate-ota-method">
<h3>Alternate OTA Method<a class="headerlink" href="#alternate-ota-method" title="Permalink to this headline">¶</a></h3>
<p>I also created an updater app with Python/Java, so here is that tutorial:</p>
<blockquote>
<div><div style="text-align: center; margin-bottom: 2em;">
        <iframe width="560" height="315" src="https://www.youtube.com/embed/iMPBpUdL-rk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div><ul class="simple">
<li>The <a class="reference external" href="https://github.com/krdarrah/ESP32_GUI_Programmer">GUI can be downloaded here</a> - you can download the entire zip, then just run the application for your operating system. You can download the latest BIN file from the <a class="reference external" href="https://github.com/krdarrah/trigBoardV8_BaseFirmware">Github Repository for the V8 Base Firmware</a> inside the OTA folder</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">When using the GUI, you might get a pop-up about installing an old version of Java - just make sure to install the latest version and it should work</p>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="usb-updates">
<h2>USB Updates<a class="headerlink" href="#usb-updates" title="Permalink to this headline">¶</a></h2>
<p>This is a long video showing how it can be done, but also useful for other ESP32 projects:</p>
<div style="text-align: center; margin-bottom: 2em;">
<iframe width="560" height="315" src="https://www.youtube.com/embed/jIIYrOe25S0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div></div>
<div class="section" id="compiling-uploading-base-firmware">
<h2>Compiling/Uploading Base Firmware<a class="headerlink" href="#compiling-uploading-base-firmware" title="Permalink to this headline">¶</a></h2>
<p>Latest code can always be found in the <a class="reference external" href="https://github.com/krdarrah/trigBoardV8_BaseFirmware">Github Repository</a></p>
<p>Boards are always shipped with the release code which can be found at the <a class="reference external" href="https://github.com/krdarrah/trigBoardV8_BaseFirmware/releases">releases git page</a></p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Modifications to the base firmware are encouraged, but be careful that you fully understand the existing base firmware functionality.  The firmware is responsible for both wake and shutdown functions.</p>
</div>
<p><strong>Board Settings From Tools Menu</strong></p>
<img alt="_images/boardsettings.png" class="align-center" src="_images/boardsettings.png" />
<div class="line-block">
<div class="line"><strong>Versions Prior to Release 8/16/21</strong></div>
<div class="line">* Arduino IDE v1.8.10</div>
<div class="line">* ESP32 v1.0.4  - in boards manager, after this boards manager url in preferences <a class="reference external" href="https://dl.espressif.com/dl/package_esp32_index.json">https://dl.espressif.com/dl/package_esp32_index.json</a></div>
<div class="line">* PubSubClient Library v2.7.0</div>
<div class="line">* PushSafer Library Forked <a class="reference external" href="https://github.com/krdarrah/pushsafer-arduino-library">HERE</a> Thanks to <a class="reference external" href="https://github.com/witnessmenow">Brian Lough</a></div>
<div class="line">* Arduino Json Library v6.13.0</div>
</div>
<div class="line-block">
<div class="line"><strong>Versions with latest 8/16/21</strong></div>
<div class="line">* Arduino IDE v1.8.15</div>
<div class="line">* ESP32 v1.0.6  - in boards manager, after this boards manager url in preferences <a class="reference external" href="https://dl.espressif.com/dl/package_esp32_index.json">https://dl.espressif.com/dl/package_esp32_index.json</a></div>
<div class="line">* PubSubClient Library v2.8.0</div>
<div class="line">* Arduino Json Library v6.18.0</div>
<div class="line">* UniversalTelegramBot Library v1.3.0</div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<div class="line-block">
<div class="line"><em>For USB Programming</em></div>
<div class="line">I recommend using the KD Circuits Designed <a class="reference external" href="https://www.tindie.com/products/13817">FTDI USB-Serial Converter</a></div>
<div class="line-block">
<div class="line"><strong>Jumpers set to 3.3V and OFF</strong></div>
</div>
</div>
<div class="last line-block">
<div class="line"><strong>You need to power the board from the battery connector NOT the USB-Serial Converter</strong></div>
<div class="line-block">
<div class="line">Don’t worry though the power pin on the programming header is not connected.  5V logic level on the programming header CAN damage the ESP32 though.</div>
</div>
<div class="line"><strong>For development purposes, you can power the board by the 3.3V pin directly by applying 3.3V volts</strong></div>
<div class="line-block">
<div class="line">Make sure to not have anything connected to the battery input and also note that the board will not sleep now.  Some people like this for testing code out and it makes it easier to upload, since you don’t have to wake up before uploading.</div>
</div>
</div>
</div>
</div>
<div class="section" id="custom-firmware">
<h2>Custom Firmware<a class="headerlink" href="#custom-firmware" title="Permalink to this headline">¶</a></h2>
<p>The trigBoard uses the popular ESP32 WiFi+Bluetooth module, which is great due to the extensive resources and support for this platform.  The base firmware can be used as-is, but many users prefer to connect to their own service or do other unique things, while enjoying the ultra low power capability with the trigBoard.  This is easy enough though, but is suggested to modify the base firmware and utilize the “low power engine”.  Let’s review the <code class="code docutils literal notranslate"><span class="pre">void</span> <span class="pre">setup()</span></code> function to see how custom code can be embedded (just note this may be slightly outdated, but all still applies)</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span>  <span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
          <span class="n">pinMode</span><span class="p">(</span><span class="n">ESPlatchPin</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
          <span class="n">digitalWrite</span><span class="p">(</span><span class="n">ESPlatchPin</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
          <span class="n">pinMode</span><span class="p">(</span><span class="n">LEDpin</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
          <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
          <span class="n">checkWakeupPins</span><span class="p">();</span>
          <span class="n">loadConfiguration</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
          <span class="n">rtcInit</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">timerCountDown</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
          <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">getBattery</span><span class="p">(),</span> <span class="mi">2</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">pushLogic</span><span class="p">())</span> <span class="p">{</span> <span class="c1">//decide if push will occur or nt and what message will be</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">wiFiNeeded</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">connectWiFi</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">pushOver</span><span class="p">();</span>
                <span class="n">pushSafer</span><span class="p">();</span>
                <span class="n">ifttt</span><span class="p">();</span>
                <span class="n">mqtt</span><span class="p">();</span>
              <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">udp</span><span class="p">();</span>
            <span class="n">tcp</span><span class="p">();</span>
          <span class="p">}</span>
          <span class="n">killPower</span><span class="p">();</span>
          <span class="n">waitForButton</span><span class="p">();</span>
          <span class="n">initBluetooth</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the loop, you’ll notice that not much happens.  This is because the trigBoard is designed to only run the code in the setup, then go to sleep.  If it ends up in the loop, means that the user held the wake button and it’s handling the bluetooth connection or an OTA (OVER THE AIR) firmware update.  Because Pushover, Pushsafer, ifttt, etc are not used then you can just delete all of this out.  Your setup may look like this then:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span>  <span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
          <span class="n">pinMode</span><span class="p">(</span><span class="n">ESPlatchPin</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
          <span class="n">digitalWrite</span><span class="p">(</span><span class="n">ESPlatchPin</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>
          <span class="n">pinMode</span><span class="p">(</span><span class="n">LEDpin</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
          <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
          <span class="n">checkWakeupPins</span><span class="p">();</span>
          <span class="n">loadConfiguration</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
          <span class="n">rtcInit</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">timerCountDown</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
          <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">getBattery</span><span class="p">(),</span> <span class="mi">2</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">pushLogic</span><span class="p">())</span> <span class="p">{</span> <span class="c1">//decide if push will occur or nt and what message will be</span>

          <span class="c1">//*** CUSTOM CODE GOES HERE **</span>

          <span class="p">}</span>
          <span class="n">killPower</span><span class="p">();</span>
          <span class="n">waitForButton</span><span class="p">();</span>
          <span class="n">initBluetooth</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This code here still works with the configurator, which is important since that’s how the wake events are setup. But how to use the wake message in the custom code? The message used to send push notifications is simply <code class="code docutils literal notranslate"><span class="pre">pushMessage</span></code> which is just a character array. The trigBoard name set in the Configurator is <code class="code docutils literal notranslate"><span class="pre">config.trigName</span></code> - also a char array.  You experiment with this and Serial.print these out to the monitor so you can see how the message can be formatted.</p>
<p>Something else that is extremely useful is using the unused Configurator settings for other things - for example, since now you’re not using Pushover, Pushsafer, etc… you can enable those in the Configurator and set values there too be used in your custom code.  Like if you need to add an API key to your custom code, just use the Pushover API key <code class="code docutils literal notranslate"><span class="pre">config.pushAPIKey</span></code>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="testing.html" class="btn btn-neutral float-right" title="Testing/Factory Programming" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Hardware.html" class="btn btn-neutral float-left" title="Hardware" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Kevin Darrah

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>