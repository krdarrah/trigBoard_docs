

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Cellular/Battery Backed System &mdash; trigBoard
Version 8 0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Motion Sensor - PIR" href="motionSensor.html" />
    <link rel="prev" title="E-Paper Corona Display" href="ePaperCoronaDisplay.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html">
          

          
            
            <img src="_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">trigBoard v8 Docs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="wheretobuy.html">Where To Buy</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="configurator.html">Configurator</a></li>
<li class="toctree-l1"><a class="reference internal" href="supportedServices.html">Supported Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="Hardware.html">Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="Firmware.html">Firmware/Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing/Factory Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="contact.html">Contact</a></li>
</ul>
<p class="caption"><span class="caption-text">Projects</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="ePaperCoronaDisplay.html">E-Paper Corona Display</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Cellular/Battery Backed System</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#trigboard-setup">trigBoard Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gateway-setup">Gateway Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#hardware-needed">Hardware Needed</a></li>
<li class="toctree-l3"><a class="reference internal" href="#trigboard-gateway-software">trigBoard Gateway Software</a></li>
<li class="toctree-l3"><a class="reference internal" href="#particle-software">Particle Software</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#monitor-setup">Monitor Setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">Hardware Needed</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connections">Connections</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adafruit-esp32-monitor-software">Adafruit ESP32 Monitor Software</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mp3-files">mp3 files</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#repeaters-range-extenders">Repeaters - Range Extenders</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="motionSensor.html">Motion Sensor - PIR</a></li>
<li class="toctree-l1"><a class="reference internal" href="waterleakDetector.html">Water Leak Detector</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">trigBoard
Version 8</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Cellular/Battery Backed System</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/cellularProject.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="cellular-battery-backed-system">
<h1>Cellular/Battery Backed System<a class="headerlink" href="#cellular-battery-backed-system" title="Permalink to this headline">¶</a></h1>
<img alt="_images/cellularBlockDiag.png" class="align-center" src="_images/cellularBlockDiag.png" />
<p>This is actually the preferred method for using the trigBoard - a complete low power system that relies on no existing WiFi/Internet and can even get push notifications out when there is a power outage!</p>
<ul class="simple">
<li>A central Gateway is installed in the system, where an ESP32 is configured to be a WiFi Access point.  By default, the SSID is hidden for security purposes.  This also means this is a private network hosted in the trigBoard system, meaning any existing WiFi is not relied upon.</li>
<li>trigBoard communication to the gateway is done using UDP messaging.  This is very fast, and since no cloud communication is needed, the trigBoard message can be sent out very quickly and it can go back to sleep faster (saves battery life). This can be setup from the configurator with the base firmware.</li>
<li>A <a class="reference external" href="https://store.particle.io/collections/cellular/products/boron-lte">Particle Boron</a> is also on the gateway to provide cellular connectivity to send push notifications without the need for existing WiFi/Internet connection.  At the time of writing this, the data plan from particle is $3/mo</li>
<li>Local monitors in the system can play mp3 files based on what even took place.  Like if the Front Door is opened, these monitors will immediately play a custom mp3 “The Front Door has Opened”  These work on the same private WiFi network hosted by the gateway - when a message is received by a trigBoard sensor, it is immediately forwarded out to monitors.</li>
<li>Battery Backed! Obviously all trigBoard sensors are all on batteries, but the gateway is battery backed by the on-board Particle Boron battery connection. The monitors are also battery backed with the use of Adafruit’s ESP32 Feather board having on-board battery connection and USB charging.</li>
<li>KD Circuits has designed simple carrier boards for gateway and monitor boards - just bare PCB here, but easy to solder together with all through hole components.  $2/pc <a class="reference external" href="https://www.kdcircuits.com#contact">contact KD Circuits directly</a></li>
</ul>
<div class="section" id="trigboard-setup">
<h2>trigBoard Setup<a class="headerlink" href="#trigboard-setup" title="Permalink to this headline">¶</a></h2>
<p>This is actually the easiest part! The messages are sent out via UDP, so setup the trigBoard as you normally would, but just enable udp from the configurator.  Timer settings, open/closed, etc… are all however you want them to work.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<div class="last line-block">
<div class="line">Three things need to be decided</div>
<div class="line">1-SSID will be whatever you want - pick something random like “ajhagwiuycgwerilucberw” just don’t use special characters</div>
<div class="line">2-Password also something random- AT LEAST 8 characters and nothing special</div>
<div class="line">3-Port for the UDP messaging, I just use 1234</div>
<div class="line"><strong>Write these down somewhere, we’ll need them for setting everything up</strong></div>
</div>
</div>
<div class="line-block">
<div class="line">Here is my setup:</div>
</div>
<img alt="_images/udpSetup_cell.png" class="align-center" src="_images/udpSetup_cell.png" />
<ul class="simple">
<li><strong>SSID</strong> Custom SSID to be used for this private network.  This is only used by trigBoards in this system, so do not use your existing WiFi credentials here.  Make something up that is totally random.  try to use just letters and numbers, like “hgkjgKJGH687G” at least 8 characters.  Keep this information somewhere secure, since we’ll need to set everything else up and other trigBoards in the future.</li>
<li><strong>Password</strong> Same as SSID, something random, at least 8 characters like “jklhoilhJLKHHj8907h”</li>
<li><strong>Static IP</strong> You can set this to 192.168.4.102 if you’d like, or give each of your trigBoards something like 192.168.4.102, 192.168.4.103, 192.168.4.104  Just make sure to start at .102 and you could even give each trigBoard the same ip address.  The only risk there is if two trigBoards are triggered at the same exact time and both have the same static IP address.</li>
<li><strong>Target IP</strong> Must be  192.168.4.1 - this is the ip Address of the gateway where the messages are all sent</li>
<li><strong>Target Port</strong> You can set this to anything you want, but I normally set to 1234</li>
<li><strong>Subnet</strong> Set to 255.255.0.0</li>
<li><strong>Primary DNS</strong> Set to 8.8.8.8</li>
<li><strong>Secondary DNS</strong> Set to 8.8.4.4</li>
<li><strong>Blast Count</strong> Here is where you can get creative - UDP is a one way kind of message service, so how do we know the message got through? Well we don’t and would take too much time to acknowledge back and forth, so best to just send a blast of messages!  I recommend 10-25 messages for this.  The battery calculations were done with a 20 message blast.</li>
<li><strong>Time Between Blasts</strong> This is the time between each message as they’re sent out.  10 has worked pretty good for all of my testing.</li>
</ul>
<div class="line-block">
<div class="line"><strong>How to set which mp3 to play on which event</strong></div>
<div class="line-block">
<div class="line">If using a Monitor to play mp3 files, setting this is done on each trigBoard through the configurator.  Very Easy! Each file on the SD card starts with a number, so these numbers are added in to the messages you set in the configurator:</div>
</div>
</div>
<img alt="_images/mp3message.png" class="align-center" src="_images/mp3message.png" />
<p>So you can see -5- or -7- or -2- is appended to the messages. If you don’t want a certain message to be played by the monitor, just don’t add the number</p>
</div>
<div class="section" id="gateway-setup">
<h2>Gateway Setup<a class="headerlink" href="#gateway-setup" title="Permalink to this headline">¶</a></h2>
<img alt="_images/gatewayPic.JPG" class="align-center" src="_images/gatewayPic.JPG" />
<div class="section" id="hardware-needed">
<h3>Hardware Needed<a class="headerlink" href="#hardware-needed" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">* trigBoard is ideal for the Private network side, but you can adapt this to any ESP32 board</div>
<div class="line">* <a class="reference external" href="https://store.particle.io/collections/cellular/products/boron-lte">Particle Boron</a></div>
<div class="line">* A good sized Lithium battery - you can see above that use a giant 5000mAh battery.  The bigger the better so that if you loose power, it will run for a long time.  <strong>The Battery plugs into the Particle Boron</strong> which supports the Adafruit Feather form factor, so any of the batteries <a class="reference external" href="https://www.adafruit.com/category/574">they sell</a> will work - always double check polarity though!!</div>
<div class="line">* You can make life a lot easier if you purchase a gateway carrier board from KD Circuits - then just some spare headers are needed to solder down the trigBoard (see picture above)</div>
</div>
<div class="line-block">
<div class="line"><strong>This is the PCB Design for reference:</strong></div>
</div>
<blockquote>
<div><img alt="_images/BoronCarrier.png" class="align-center" src="_images/BoronCarrier.png" />
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Expansion pins from the trigBoard are brought out specifically for adding lights/alarms/etc… or even a “silence button/switch”</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Do not connect anything to the trigBoard’s battery or sensor connectors! The battery backup is provided by the Particle Boron and continuous power is through the Boron’s micro USB port (just like the picture above)</p>
</div>
<div class="line-block">
<div class="line"><strong>Silent Button/Switch</strong></div>
<div class="line">This is completely optional, but the gateway code supports a silent button/switch to prevent messages from being sent out only to the monitors.  If you have these monitors installed throughout the house and you have a trigBoard mounted on a high-traffic location, the monitor can get pretty annoying!  Note that this code only silences the monitor, not the particle, so the push notifications still go out.  In the code, it’s easy to see how this works though, so you can make this operate however you may need.</div>
<div class="line">The switch is wired from GND to GPIO12 where CLOSED = SILENT</div>
</div>
<blockquote>
<div><img alt="_images/silentButton.png" class="align-center" src="_images/silentButton.png" />
</div></blockquote>
</div>
<div class="section" id="trigboard-gateway-software">
<h3>trigBoard Gateway Software<a class="headerlink" href="#trigboard-gateway-software" title="Permalink to this headline">¶</a></h3>
<p>latest code can be downloaded in the <a class="reference external" href="https://github.com/krdarrah/trigBoard_GatewayV8">Gateway Git Repository</a></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="simple">
<li>This is all based on the Base Firmware, so make sure you have all of those dependencies and versions of libraries installed first.</li>
<li>I use the same board settings as well</li>
<li><strong>Software Serial</strong> is used to communicate to the Particle Boron, so for the ESP32, I had to install EspSoftwareSerial first before compiling:</li>
</ul>
<img alt="_images/EspSoftwareSerialImg.png" class="align-center" src="_images/EspSoftwareSerialImg.png" />
<ul class="last simple">
<li>USB-Serial Programming is recommended</li>
</ul>
</div>
<p>Configuration of the trigBoard settings is also done through the configurator! On bootup, you’ll notice the Blue LED flashing - it will do this for about 5 minutes, allowing you to connect to it through the google chrome <a class="reference external" href="https://kevindarrah.com/configurator/">Configurator Tool</a>  You should see trigBoard Gateway now in the scan list.</p>
<blockquote>
<div><p>Because this is a Gateway acting as the Access Point, you will not be connecting to any SSID, instead you will specify the SSID and password for this private network.  Most of the functionality in the configurator - you set this here in WiFi SSID and Password - then click “Save and Connect…”</p>
<blockquote>
<div><img alt="_images/gatewayWiFiSet.png" class="align-center" src="_images/gatewayWiFiSet.png" />
</div></blockquote>
<p>Then the only other setting is when you enable UDP, you can set the port number. <strong>ALL OTHER SETTINGS DO NOTHING</strong></p>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">After saving the WiFi Settings for the gateway, <strong>YOU HAVE TO PRESS THE RESET BUTTON ON THE TRIGBOARD</strong>  This is because, the settings won’t take effect until the board boots up.  You can test things at this point with the USB-Serial Converter and look at the Serial Monitor debug window.  When a trigBoard sends a message to it, you should see some activity!</p>
</div>
</div>
<div class="section" id="particle-software">
<h3>Particle Software<a class="headerlink" href="#particle-software" title="Permalink to this headline">¶</a></h3>
<p>This part is very easy once you get your Particle Boron Commissioned - follow the particle tutorials to get all set up and running so that you see the breathing Cyan LED on the board.  It would be a good idea to at least get familiar with flashing code to the Boron from their <a class="reference external" href="https://build.particle.io/build/new">web IDE</a></p>
<p>Then all you’ll do is paste the code in below, check you have the right board selected (bottom right of IDE), and flash the board by clicking the lightening bolt symbol (upper left of IDE)</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">String</span> <span class="n">str1</span><span class="p">,</span><span class="n">str2</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span><span class="c1">//debug</span>
    <span class="n">Serial1</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span><span class="c1">//from trigBoard</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Serial1</span><span class="p">.</span><span class="n">available</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="c1">// new data came in</span>
     <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;New Data&quot;</span><span class="p">);</span>
     <span class="n">str1</span> <span class="o">=</span> <span class="n">Serial1</span><span class="p">.</span><span class="n">readStringUntil</span><span class="p">(</span><span class="sc">&#39;,&#39;</span><span class="p">);</span><span class="c1">//that&#39;s the separator</span>
     <span class="n">str2</span> <span class="o">=</span> <span class="n">Serial1</span><span class="p">.</span><span class="n">readStringUntil</span><span class="p">(</span><span class="sc">&#39;#&#39;</span><span class="p">);</span>
     <span class="n">sendData</span><span class="p">();</span>
     <span class="n">Serial1</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sendData</span><span class="p">(){</span>
     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">startConnectTime</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
     <span class="kt">char</span> <span class="n">pushMessage</span><span class="p">[</span><span class="mi">50</span><span class="p">],</span> <span class="n">pushName</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
     <span class="n">str1</span><span class="p">.</span><span class="n">toCharArray</span><span class="p">(</span><span class="n">pushName</span><span class="p">,</span> <span class="n">str1</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
     <span class="n">str2</span><span class="p">.</span><span class="n">toCharArray</span><span class="p">(</span><span class="n">pushMessage</span><span class="p">,</span> <span class="n">str2</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
     <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">str1</span><span class="p">);</span>
     <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">str2</span><span class="p">);</span>

     <span class="n">String</span> <span class="n">adaFruitData</span> <span class="o">=</span> <span class="s">&quot;[{</span><span class="se">\&quot;</span><span class="s">key</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">house</span><span class="se">\&quot;</span><span class="s">, </span><span class="se">\&quot;</span><span class="s">value</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">;</span>
     <span class="n">adaFruitData</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span><span class="n">str1</span><span class="p">);</span>
     <span class="n">adaFruitData</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">}]&quot;</span><span class="p">);</span>
     <span class="n">Particle</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="s">&quot;homeSecurityPost&quot;</span><span class="p">,</span> <span class="n">adaFruitData</span><span class="p">,</span> <span class="n">PRIVATE</span><span class="p">,</span> <span class="n">NO_ACK</span><span class="p">);</span>

     <span class="n">String</span> <span class="n">pushoverPacket</span> <span class="o">=</span> <span class="s">&quot;[{</span><span class="se">\&quot;</span><span class="s">key</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">title</span><span class="se">\&quot;</span><span class="s">, </span><span class="se">\&quot;</span><span class="s">value</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">;</span>
     <span class="n">pushoverPacket</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span><span class="n">str1</span><span class="p">);</span>
     <span class="n">pushoverPacket</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">},&quot;</span><span class="p">);</span>
     <span class="n">pushoverPacket</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span><span class="s">&quot;{</span><span class="se">\&quot;</span><span class="s">key</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">message</span><span class="se">\&quot;</span><span class="s">, </span><span class="se">\&quot;</span><span class="s">value</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
     <span class="n">pushoverPacket</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span><span class="n">str2</span><span class="p">);</span>
     <span class="n">pushoverPacket</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">}]&quot;</span><span class="p">);</span>
     <span class="n">Particle</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="s">&quot;pushover&quot;</span><span class="p">,</span> <span class="n">pushoverPacket</span><span class="p">,</span> <span class="n">PRIVATE</span><span class="p">);</span><span class="c1">//then send to push over so we get the notifications on our mobile devices</span>

     <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">startConnectTime</span><span class="p">);</span>
     <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">&quot;ms to connect&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This code receives data from the trigBoard then sends out to the cloud - both to Pushover and to AdafruitIO.  Why both? Well you may want to do other things with this data, so Adafruit can keep a log of all of the notifications and you can tie that to other things around the internet like IFTTT or even notify other trigBoard systems.  Like let’s say you have a remote system setup and you want your local monitors to speak when something in that location occurs.  You can have one Master system configured to also monitor an Adafruit feed to push data back out from the gateway to the monitors. And Adafruit’s service is free, so we can set that up now and expand the system later on.  Let’s set these things up now:</p>
<ol class="arabic simple">
<li>Set up and account at <a class="reference external" href="https://io.adafruit.com">io.adafruit.com</a></li>
<li>You’ll see something in there where to get your Adafruit IO Key - we’ll need this later for the webhook from Particle to send data here</li>
<li>Create a new feed and call it something - this is where all notification data is sent - in my code above, all data is sent to the feed named “house”.  You can change this, but just make sure you also change in the code.</li>
<li>You probably already have this setup, but go and set up an account with <a class="reference external" href="https://pushover.net">pushover.net</a> - the push notifications will be sent here. We’ll need both the user and API keys - <a class="reference internal" href="supportedServices.html#pushover"><span class="std std-ref">go here</span></a> for instructions on where to get those</li>
<li>So now we’re all setup to create the webhooks needed for the Particle Boron to send data out to Adafruit and Pushover.  Head over to <a class="reference external" href="https://console.particle.io/integrations">Integrations</a> and create a new one and select Webhook. The Event Name can be whatever you want, but note that my Boron Code above is calling “homeSecurityPost”, so if you do change this, make sure to also change in the code. The URL is setup like this: <a class="reference external" href="https://io.adafruit.com/api/v2/krdarrah/groups/feeds/data">https://io.adafruit.com/api/v2/krdarrah/groups/feeds/data</a></li>
</ol>
<p>See the “krdarrah” in there? that’s where you’ll put your adafruit user name, and also make sure your settings look like this:</p>
<img alt="_images/adafruitWebhook.png" class="align-center" src="_images/adafruitWebhook.png" />
<p>Expand the advanced settings and set the custom JSON data to look like this:</p>
<div class="highlight-JSON notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;feeds&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;{{{0.value}}}&quot;</span><span class="p">,</span>
      <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;{{{0.key}}}&quot;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Scroll down to the HTTP HEADERS and ADD ROW twice, so that you can add your Adafruit IO key and Host:</p>
<img alt="_images/adafruitHeaders.png" class="align-center" src="_images/adafruitHeaders.png" />
<p>Everything else can be left alone, so you can save this and should be good to go with Adafruit IO.  Let’s create the Pushover Webhook next, so follow that same process in creating a new webhook with the Event Name called “pushover”, URL = <a class="reference external" href="https://api.pushover.net/1/messages.json">https://api.pushover.net/1/messages.json</a> and change the settings so it looks like this:</p>
<img alt="_images/pushoverwebhook.png" class="align-center" src="_images/pushoverwebhook.png" />
<p>Next, we’ll go to the advanced settings and and add a couple rows and set this up like:</p>
<img alt="_images/pushoverForm.png" class="align-center" src="_images/pushoverForm.png" />
<p>You’ll notice where you paste in your user and API tokens from pushover.net.  You can also change the sound of the notification, but I’ve only ever used the bike sound, so not sure what options you have here.</p>
<p>Everything else can be left alone, so save this and you now have both webhooks good to go!</p>
</div>
</div>
<div class="section" id="monitor-setup">
<h2>Monitor Setup<a class="headerlink" href="#monitor-setup" title="Permalink to this headline">¶</a></h2>
<p>The monitor is what really makes this cellular system come together.  These can  play any mp3 file you want based on a trigBoard event (see above for the trigBoard setup for how to assign mp3 files).  I like to have these files be announcements like “The front door has opened”, “The garage is still open”, etc… What’s also nice about the monitor is that it is also battery backed and connects to the same private network as the trigBoards do back to the gateway. A “broadcast” UDP message is sent out from the gateway to all listening monitors with instructions as to which mp3 to play.</p>
<img alt="_images/monitorhardware.png" class="align-center" src="_images/monitorhardware.png" />
<div class="section" id="id2">
<h3>Hardware Needed<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>This is actually based on <a class="reference external" href="https://www.adafruit.com/product/3591">Adafruit’s ESP32 Feather board</a> Why? well because this has the battery connector and charging already on board.</li>
<li>And you’re going to want a battery as well - might as well get one from <a class="reference external" href="https://www.adafruit.com/category/574">adafruit</a> I would say 1000mAh or so would give a couple hours of backup power, but feel free to go as big as you want here.</li>
<li>YX5300 mp3 board like this:</li>
</ul>
<img alt="_images/YX5300amazon.png" class="align-center" src="_images/YX5300amazon.png" />
<p>Ideally, this is a genuine YX5300 based board, but these are hard to find.  Most will have a chip marked with some kind JC… These are not as good and don’t support all of the same commands as the YX5300… some say JC stands for “Just Crap”  Either way, I was able to get my Monitor Code to work with both, so you should be fine - just search ebay/amazon/etc for YX5300 and you should see a board that looks like this.  Also, don’t forget a microSD card - nothing special or too big. You won’t need a lot of space…</p>
<ul class="simple">
<li>For the amplifier/speaker, I use these little kits based on the PAM8403</li>
</ul>
<img alt="_images/ampSpeaker.png" class="align-center" src="_images/ampSpeaker.png" />
<ul class="simple">
<li>In a quiet bedroom, you want this to be completely silent (no speaker hum), so I simply kill power to the amplifier with a P-Channel Mosfet - <a class="reference external" href="https://www.digikey.com/product-detail/en/microchip-technology/TP0606N3-G/TP0606N3-G-ND/4902382">TP0606N3-G</a></li>
<li>A monitor carrier board from KD Circuits makes this project a lot easier.  Everything is all setup for the Adafruit Feather board, connections to the YX5300 board and P-CH MOSFET switch power to the Amplifier - contact KD Circuits for more info on this board.  Here is the design for reference:</li>
</ul>
<img alt="_images/monitorBoardOutline.png" class="align-center" src="_images/monitorBoardOutline.png" />
<img alt="_images/monitorSCH.png" class="align-center" src="_images/monitorSCH.png" />
</div>
<div class="section" id="connections">
<h3>Connections<a class="headerlink" href="#connections" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="44%" />
<col width="56%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Adafruit ESP32</th>
<th class="head">YX5300 mp3 Board</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>GND</td>
<td>GND</td>
</tr>
<tr class="row-odd"><td>3V3</td>
<td>VCC</td>
</tr>
<tr class="row-even"><td>33 (RX)</td>
<td>TX</td>
</tr>
<tr class="row-odd"><td>32 (TX)</td>
<td>RX</td>
</tr>
</tbody>
</table>
<img alt="_images/MonitorYX5300Connections.png" class="align-center" src="_images/MonitorYX5300Connections.png" />
<p>The 3.5mm audio jack that comes with the PAM8403 kit can be used to plug into the output of the YX5300 board and wire into the audio input of the PAM8403 amplifier board:</p>
<table border="1" class="docutils">
<colgroup>
<col width="44%" />
<col width="56%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">3.5mm Audio Cable</th>
<th class="head">PAM8403 Amplifier board</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>WHITE</td>
<td>L</td>
</tr>
<tr class="row-odd"><td>BLACK</td>
<td>G</td>
</tr>
<tr class="row-even"><td>RED</td>
<td>B</td>
</tr>
</tbody>
</table>
<img alt="_images/PAM8403connections.png" class="align-center" src="_images/PAM8403connections.png" />
<p>Then the power for the PAM8403 amplifier will wire from the drain of the P-CH MOSFET, and hook up the speaker (I use the right channel only)</p>
<p>Then that’s all there is to it! You can keep power always on with the USB cable to the Adafruit ESP32 board (and also keeps the battery charged)</p>
</div>
<div class="section" id="adafruit-esp32-monitor-software">
<h3>Adafruit ESP32 Monitor Software<a class="headerlink" href="#adafruit-esp32-monitor-software" title="Permalink to this headline">¶</a></h3>
<p>Latest code can be find in the <a class="reference external" href="https://github.com/krdarrah/trigBoard_MonitorV8">trigBoard Monitor Git Repository</a></p>
<p><strong>*Big thanks to the YX5300 code found here!*</strong> <a class="reference external" href="https://github.com/salvadorrueda/ArduinoSerialMP3Player/blob/master/ArduinoSerialMP3Player/ArduinoSerialMP3Player.ino">salvadorrueda github</a></p>
<p>Just like the Gateway software, all of the same dependencies are needed as well as the ESPsoftware serial library.  If you can compile the gateway software, then you should be fine here.  I also use the same board settings as the trigBoard.</p>
<p>And just like the gateway, this board is also configured through the Configurator!  On bootup, you’ll see the LED flashing on the board (for 5min)- only when this is flashing can you connect to it from the Configurator.  Only a few settings are needed:</p>
<ul class="simple">
<li>Use the main WiFi Settings at the top of the configurator to connect to the private network.  You can set this to use a static IP if you want, but I recommend DHCP (static IP box unchecked).</li>
<li>Scroll down and enable UDP.  All of these settings are not used, except the port. Most people use 1234, but if you’re using something else, you can change here.</li>
</ul>
</div>
<div class="section" id="mp3-files">
<h3>mp3 files<a class="headerlink" href="#mp3-files" title="Permalink to this headline">¶</a></h3>
<p>These can be anything you want, but I like the announcements “The Front Door has opened”  I create these mp3 files here: <a class="reference external" href="https://ttsmp3.com">ttsmp3.com</a></p>
<p>Now, these files need to be named and follow a very specific file directory on the SD card. Everything is about keeping the files in order, so create a folder and name is “01” and place all of your mp3 files in there.  Recall that each trigBoard message calls out a number, which corresponds to a specific mp3 file.  You can just name these 000,001,002,003, etc… or do it like how I have it here:</p>
<img alt="_images/sdcradmp3files.png" class="align-center" src="_images/sdcradmp3files.png" />
<p>Then let’s take an example -  you see how I set the trigBoard up to play “The backdoor has opened” and “the backdoor has closed” again, you just append the message with a -#- where # is the track number</p>
<img alt="_images/trigBoardmessageexample.png" class="align-center" src="_images/trigBoardmessageexample.png" />
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">I actually keep the exact files I use as part of my source code - so you can use those files as well if you want!</p>
</div>
</div>
</div>
<div class="section" id="repeaters-range-extenders">
<h2>Repeaters - Range Extenders<a class="headerlink" href="#repeaters-range-extenders" title="Permalink to this headline">¶</a></h2>
<p>If you need better range with this system, you can add repeaters.  I found some NAT router code for the ESP32 that seems to work pretty good, so I loaded this up on a couple Adafruit ESP32 boards (with batteries).  You can find that code on <a class="reference external" href="https://github.com/martin-ger/esp32_nat_router">martin-ger git page</a></p>
<p>Then load the binaries directy onto an ESP32… I have plans on making a video testing the capabilities of using these, like do they actually work for this trigBoard application? I’ve had them installed for months without issue, but not sure if all trigBoards communicate directly with the gateway or through the repeaters.  I did get a chance to test this out:</p>
<div style="text-align: center; margin-bottom: 2em;">
<iframe width="560" height="315" src="https://www.youtube.com/embed/YHjM2KAqjU0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div></div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="motionSensor.html" class="btn btn-neutral float-right" title="Motion Sensor - PIR" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="ePaperCoronaDisplay.html" class="btn btn-neutral float-left" title="E-Paper Corona Display" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Kevin Darrah

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>